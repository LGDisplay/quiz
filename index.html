<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Quiz T·ª´ V·ª±ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    input[type="number"], button, input[type="text"] {
      font-size: 16px;
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .question {
      margin-top: 20px;
    }
    .options button {
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .options button:hover {
      background-color: #ddd;
    }
    .correct {
      background-color: #c8f7c5 !important;
    }
    .wrong {
      background-color: #f8c8c8 !important;
    }
    #result {
      font-weight: bold;
      margin-top: 15px;
      font-size: 18px;
    }
    #nextBtn {
      display: none;
      margin-top: 10px;
    }
    .explanation {
      margin-top: 10px;
      font-size: 14px;
      background: #f4f4f4;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>Quiz T·ª´ V·ª±ng</h1>
  <label>S·ªë c√¢u h·ªèi:
    <input type="number" id="questionCount" value="6" min="1" />
  </label>
  <button onclick="startQuiz()">B·∫Øt ƒë·∫ßu</button>

  <div id="quizContainer" style="display:none;">
    <div id="quiz"></div>
    <button id="nextBtn" onclick="nextQuestion()">C√¢u ti·∫øp</button>
    <div id="result"></div>
  </div>

  <script>
    const SHEET_ID = '12toS1i8xTwjWauVUICzgNyW-ZYBgk32z9nyRlIMFHYQ'; // ‚Üê Thay b·∫±ng Sheet ID
    const SHEET_NAME = 'English';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

    let data = [], quiz = [], current = 0, correct = 0;

    function startQuiz() {
      fetch(SHEET_URL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          data = json.table.rows.map(r => ({
            english: r.c[0]?.v?.trim() || '',
            vietnamese: r.c[1]?.v?.trim() || ''
          })).filter(d => d.english && d.vietnamese);

          if (data.length < 4) {
            alert("Danh s√°ch t·ª´ qu√° √≠t!");
            return;
          }

          generateQuiz();
        });
    }

    function generateQuiz() {
      const count = parseInt(document.getElementById('questionCount').value);
      const shuffled = [...data].sort(() => 0.5 - Math.random());
      const availableCount = Math.min(count, data.length);
      const numWritten = Math.floor(availableCount * 2 / 6);
      const numMC = availableCount - numWritten;

      const questions = [];
      const used = new Set();

      function getUniqueQuestion() {
        let entry;
        do {
          entry = shuffled[Math.floor(Math.random() * shuffled.length)];
        } while (used.has(entry.english + entry.vietnamese));
        used.add(entry.english + entry.vietnamese);
        return entry;
      }

      for (let i = 0; i < numMC; i++) {
        const q = getUniqueQuestion();
        const isReversed = Math.random() < 0.5;
        const correct = isReversed ? q.english : q.vietnamese;
        const prompt = isReversed ? q.vietnamese : q.english;

        const wrongs = new Set();
        while (wrongs.size < 3) {
          const r = data[Math.floor(Math.random() * data.length)];
          const distractor = isReversed ? r.english : r.vietnamese;
          if (distractor !== correct) wrongs.add(distractor);
        }

        const options = [...wrongs, correct].sort(() => 0.5 - Math.random());
        questions.push({ type: "mc", prompt, correct, options, isReversed });
      }

      for (let i = 0; i < numWritten; i++) {
        const q = getUniqueQuestion();
        const isReversed = Math.random() < 0.5;
        const prompt = isReversed ? q.vietnamese : q.english;
        const answer = isReversed ? q.english : q.vietnamese;
        questions.push({ type: "written", prompt, correct: answer });
      }

      quiz = questions.sort(() => 0.5 - Math.random());
      current = 0;
      correct = 0;
      document.getElementById('quizContainer').style.display = 'block';
      showQuestion();
    }

    function showQuestion() {
      document.getElementById('nextBtn').style.display = 'none';
      document.getElementById('result').textContent = '';

      if (current >= quiz.length) {
        document.getElementById('quiz').innerHTML = '';
        document.getElementById('result').innerHTML = `üéâ Ho√†n th√†nh! B·∫°n ƒë√∫ng ${correct}/${quiz.length} c√¢u.`;
        return;
      }

      const q = quiz[current];
      if (q.type === 'mc') {
        document.getElementById('quiz').innerHTML = `
          <div class="question">
            <h3>C√¢u ${current + 1}/${quiz.length}: "${q.prompt}" nghƒ©a l√† g√¨?</h3>
            <div class="options">
              ${q.options.map(opt => `<button onclick="checkMC(this, '${opt}', '${q.correct}', ${q.isReversed})">${opt}</button>`).join('')}
            </div>
            <div id="explanation"></div>
          </div>
        `;
      } else {
        document.getElementById('quiz').innerHTML = `
          <div class="question">
            <h3>C√¢u ${current + 1}/${quiz.length}: "${q.prompt}" ti·∫øng ${isVietnamese(q.prompt) ? 'Anh' : 'Vi·ªát'} l√† g√¨?</h3>
            <input type="text" id="writtenAnswer" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi">
            <button onclick="checkWritten()">N·ªôp</button>
          </div>
        `;
      }
    }

    function isVietnamese(text) {
      return /[·∫°√°√†·∫£√£√¢·∫•·∫ß·∫©·∫´·∫≠ƒÉ·∫Ø·∫±·∫µ·∫∑√™·∫ø·ªÅ·ªÖ·ªá·ªã·ªâ√≥√≤√µ·ªç√¥·ªë·ªì·ªô∆°·ªõ·ªù·ªü·ª£√∫√π·ªß≈©·ª•∆∞·ª©·ª´·ª≠·ªØ·ª±·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(text);
    }

    function findExplanation(word, isReversed) {
      const entry = data.find(e => isReversed ? e.english === word : e.vietnamese === word);
      return isReversed ? (entry ? entry.vietnamese : '-') : (entry ? entry.english : '-');
    }

    function checkMC(button, selected, correctAnswer, isReversed) {
      const buttons = document.querySelectorAll('.options button');
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.textContent === correctAnswer) btn.classList.add('correct');
        else if (btn.textContent === selected) btn.classList.add('wrong');
      });

      let explainHTML = '<div class="explanation"><b>Gi·∫£i th√≠ch:</b><br>';
      quiz[current].options.forEach(opt => {
        const meaning = findExplanation(opt, isReversed);
        explainHTML += `- ${opt}: ${meaning}<br>`;
      });
      explainHTML += '</div>';
      document.getElementById('explanation').innerHTML = explainHTML;

      if (selected === correctAnswer) {
        correct++;
        document.getElementById('result').textContent = '‚úÖ Ch√≠nh x√°c!';
        setTimeout(() => {
          current++;
          showQuestion();
        }, 5000);
      } else {
        document.getElementById('result').textContent = `‚ùå Sai! ƒê√°p √°n ƒë√∫ng: ${correctAnswer}`;
        document.getElementById('nextBtn').style.display = 'inline-block';
      }
    }

    function checkWritten() {
      const input = document.getElementById('writtenAnswer').value.trim().toLowerCase();
      const correctAns = quiz[current].correct.trim().toLowerCase();
      if (input === correctAns) {
        correct++;
        document.getElementById('result').textContent = '‚úÖ Ch√≠nh x√°c!';
        setTimeout(() => {
          current++;
          showQuestion();
        }, 3000);
      } else {
        document.getElementById('result').textContent = `‚ùå Sai! ƒê√°p √°n ƒë√∫ng: ${quiz[current].correct}`;
        document.getElementById('nextBtn').style.display = 'inline-block';
      }
    }

    function nextQuestion() {
      current++;
      showQuestion();
    }
  </script>
</body>
</html>
